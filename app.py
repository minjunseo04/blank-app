import streamlit as st
import pandas as pd
import plotly.express as px
import folium
from folium.plugins import MarkerCluster
from streamlit_folium import folium_static
from scipy.stats import pearsonr
import statsmodels.api as sm

st.set_page_config(layout="wide")
st.title("ì„œìš¸ì‹œ ìì¹˜êµ¬ë³„ ê³µì˜ì£¼ì°¨ì¥ vs ë¶ˆë²•ì£¼ì •ì°¨ ë¯¼ì› ë¶„ì„ ëŒ€ì‹œë³´ë“œ")

# âœ… ë°ì´í„° ë¡œë“œ
@st.cache_data
def load_data():
    df_main = pd.read_excel("ìì¹˜êµ¬ë³„_ë¯¼ì›_ì£¼ì°¨ì¥_ì¡°ì •ë²„ì „.xlsx")
    df_pop_raw = pd.read_excel("ë“±ë¡ì¸êµ¬_20250620115657.xlsx", header=None)
    df_pop_cleaned = df_pop_raw.iloc[4:25, [1, 3]].copy()
    df_pop_cleaned.columns = ['ìì¹˜êµ¬', 'ì¸êµ¬ìˆ˜']
    df_pop_cleaned['ìì¹˜êµ¬'] = df_pop_cleaned['ìì¹˜êµ¬'].astype(str).str.strip()
    df_pop_cleaned['ì¸êµ¬ìˆ˜'] = pd.to_numeric(df_pop_cleaned['ì¸êµ¬ìˆ˜'], errors='coerce').fillna(0).astype(int)

    df = df_main.merge(df_pop_cleaned, on='ìì¹˜êµ¬', how='left')
    df['ì¸êµ¬ë‹¹_ë¯¼ì›ìˆ˜'] = df['ë¶ˆë²•ì£¼ì •ì°¨_ë¯¼ì›ê±´ìˆ˜'] / df['ì¸êµ¬ìˆ˜'] * 1000
    df['ì¸êµ¬ë‹¹_ì£¼ì°¨ì¥ìˆ˜'] = df['ê³µì˜ì£¼ì°¨ì¥_ê°œìˆ˜'] / df['ì¸êµ¬ìˆ˜'] * 1000
    df['ì¸êµ¬ê¸°ì¤€_ë¯¼ì›ì£¼ì°¨ì¥ë¹„ìœ¨'] = df['ì¸êµ¬ë‹¹_ë¯¼ì›ìˆ˜'] / df['ì¸êµ¬ë‹¹_ì£¼ì°¨ì¥ìˆ˜']
    df['ì¸êµ¬_ì£¼ì°¨ì¥_ë¹„ìœ¨'] = df['ì¸êµ¬ìˆ˜'] / df['ê³µì˜ì£¼ì°¨ì¥_ê°œìˆ˜']
    return df

@st.cache_data
def load_report_data():
    df = pd.read_csv("ë¶ˆë²•ì£¼ì •ì°¨ ì‹ ê³ í˜„í™©(23ë…„11ì›”1ì¼_24ë…„3ì›”13ì¼).csv", encoding='utf-8')
    df['ìì¹˜êµ¬'] = df['ì£¼ì†Œ'].str.extract(r'ì„œìš¸íŠ¹ë³„ì‹œ\s+(\S+êµ¬)')
    df = df.dropna(subset=['ìœ„ë„', 'ê²½ë„'])
    df = df[(df['ìœ„ë„'] != 0) & (df['ê²½ë„'] != 0)]
    return df

df = load_data()
df_report = load_report_data()

# âœ… ì§€ë„ ì‹œê°í™”
st.subheader("ğŸ“ ë¶ˆë²•ì£¼ì •ì°¨ ë¯¼ì› ìœ„ì¹˜ ì§€ë„ (5,000ê±´ ëœë¤ ì¶”ì¶œ)")
seoul_map = folium.Map(location=[37.5665, 126.9780], zoom_start=11)
cluster = MarkerCluster().add_to(seoul_map)

for _, row in df_report.sample(n=5000, random_state=42).iterrows():
    popup = f"{row['ìì¹˜êµ¬']}<br>ì£¼ì†Œ: {row['ì£¼ì†Œ']}<br>ì¼ì‹œ: {row['ë¯¼ì›ì ‘ìˆ˜ì¼']}"
    folium.Marker(location=[row['ìœ„ë„'], row['ê²½ë„']], popup=popup).add_to(cluster)

folium_static(seoul_map)

# âœ… ìì¹˜êµ¬ë³„ ì‹œê°í™”
st.subheader("ğŸ“Š ìì¹˜êµ¬ë³„ ë¯¼ì› ê±´ìˆ˜ ë° ì£¼ì°¨ì¥ ê°œìˆ˜")
fig1 = px.bar(df.sort_values(by='ë¶ˆë²•ì£¼ì •ì°¨_ë¯¼ì›ê±´ìˆ˜', ascending=False),
              x='ìì¹˜êµ¬', y=['ë¶ˆë²•ì£¼ì •ì°¨_ë¯¼ì›ê±´ìˆ˜', 'ê³µì˜ì£¼ì°¨ì¥_ê°œìˆ˜'],
              barmode='group')
st.plotly_chart(fig1, use_container_width=True)

st.subheader("ğŸ“‰ ê³µì˜ì£¼ì°¨ì¥ ìˆ˜ vs ë¶ˆë²•ì£¼ì •ì°¨ ë¯¼ì›ê±´ìˆ˜")
fig2 = px.scatter(df, x='ê³µì˜ì£¼ì°¨ì¥_ê°œìˆ˜', y='ë¶ˆë²•ì£¼ì •ì°¨_ë¯¼ì›ê±´ìˆ˜',
                  text='ìì¹˜êµ¬', trendline='ols')
st.plotly_chart(fig2, use_container_width=True)

st.subheader("ğŸš— ê³µì˜ì£¼ì°¨ì¥ 1ê°œë‹¹ ì¸êµ¬ ìˆ˜")
fig3 = px.bar(df.sort_values('ì¸êµ¬_ì£¼ì°¨ì¥_ë¹„ìœ¨', ascending=False),
              x='ìì¹˜êµ¬', y='ì¸êµ¬_ì£¼ì°¨ì¥_ë¹„ìœ¨', color='ì¸êµ¬_ì£¼ì°¨ì¥_ë¹„ìœ¨')
st.plotly_chart(fig3, use_container_width=True)

st.subheader("ğŸ“Œ ì¸êµ¬ 1,000ëª…ë‹¹ ì£¼ì°¨ì¥ ìˆ˜ vs ë¯¼ì› ìˆ˜")
fig4 = px.scatter(df, x='ì¸êµ¬ë‹¹_ì£¼ì°¨ì¥ìˆ˜', y='ì¸êµ¬ë‹¹_ë¯¼ì›ìˆ˜',
                  text='ìì¹˜êµ¬', size='ê³µì˜ì£¼ì°¨ì¥_ê°œìˆ˜', color='ìì¹˜êµ¬')
st.plotly_chart(fig4, use_container_width=True)

st.subheader("ğŸ™ï¸ ì¸êµ¬ ê¸°ì¤€ ë¯¼ì›/ì£¼ì°¨ì¥ ë¹„ìœ¨ TOP 10")
top10 = df.sort_values(by='ì¸êµ¬ê¸°ì¤€_ë¯¼ì›ì£¼ì°¨ì¥ë¹„ìœ¨', ascending=False).head(10)
fig5 = px.bar(top10, x='ìì¹˜êµ¬', y='ì¸êµ¬ê¸°ì¤€_ë¯¼ì›ì£¼ì°¨ì¥ë¹„ìœ¨', color='ì¸êµ¬ê¸°ì¤€_ë¯¼ì›ì£¼ì°¨ì¥ë¹„ìœ¨')
st.plotly_chart(fig5, use_container_width=True)

# âœ… ìƒê´€ê´€ê³„ ë¶„ì„ ë° íšŒê·€ë¶„ì„
st.subheader("ğŸ“ˆ ìƒê´€ê´€ê³„ ë° íšŒê·€ë¶„ì„ ìš”ì•½")

# ìƒê´€ê´€ê³„
filtered_df = df[['ì¸êµ¬ë‹¹_ì£¼ì°¨ì¥ìˆ˜', 'ì¸êµ¬ë‹¹_ë¯¼ì›ìˆ˜']].dropna()
corr1, pval1 = pearsonr(df['ê³µì˜ì£¼ì°¨ì¥_ê°œìˆ˜'], df['ë¶ˆë²•ì£¼ì •ì°¨_ë¯¼ì›ê±´ìˆ˜'])
corr2, pval2 = pearsonr(filtered_df['ì¸êµ¬ë‹¹_ì£¼ì°¨ì¥ìˆ˜'], filtered_df['ì¸êµ¬ë‹¹_ë¯¼ì›ìˆ˜'])

# íšŒê·€ë¶„ì„
X = sm.add_constant(filtered_df['ì¸êµ¬ë‹¹_ì£¼ì°¨ì¥ìˆ˜'])
y = filtered_df['ì¸êµ¬ë‹¹_ë¯¼ì›ìˆ˜']
model = sm.OLS(y, X).fit()

# íšŒê·€ ë¶„ì„ ìš”ì•½ í…ìŠ¤íŠ¸ ì¶œë ¥
st.markdown(f"""
### ğŸ“ˆ ìƒê´€ê´€ê³„ ë¶„ì„ ìš”ì•½: ê³µì˜ì£¼ì°¨ì¥ â†” ë¶ˆë²•ì£¼ì •ì°¨ ë¯¼ì›
- ğŸ”¹ **ê³µì˜ì£¼ì°¨ì¥ ìˆ˜ vs ë¯¼ì› ê±´ìˆ˜**: ìƒê´€ê³„ìˆ˜ = **{corr1:.2f}**, p-value = **{pval1:.4f}** â†’ ì•½í•œ ìŒì˜ ìƒê´€, ìœ ì˜í•˜ì§€ ì•ŠìŒ
- ğŸ”¸ **ì¸êµ¬ 1,000ëª…ë‹¹ ì£¼ì°¨ì¥ ìˆ˜ vs ë¯¼ì› ìˆ˜**: ìƒê´€ê³„ìˆ˜ = **{corr2:.2f}**, p-value < 0.001 â†’ ë§¤ìš° ê°•í•œ ì–‘ì˜ ìƒê´€ê´€ê³„, ìœ ì˜ë¯¸ âœ…

### ğŸ“Š ë‹¨ìˆœ ì„ í˜• íšŒê·€ë¶„ì„ ê²°ê³¼
- íšŒê·€ì‹: **ì¸êµ¬ë‹¹ ë¯¼ì› ìˆ˜ = 1.46 + 58.72 Ã— ì¸êµ¬ë‹¹ ì£¼ì°¨ì¥ ìˆ˜**
- ê²°ì •ê³„ìˆ˜(RÂ²) = **0.849** â†’ ì•½ **85%** ì„¤ëª… ê°€ëŠ¥
- íšŒê·€ê³„ìˆ˜ p-value < **0.001** â†’ **ë§¤ìš° ìœ ì˜ë¯¸í•œ ê²°ê³¼**
""")

# âœ… ìš”ì•½
st.markdown("""
### âœ… ëŒ€ì‹œë³´ë“œ ìš”ì•½
- ğŸ“ ì§€ë„: ì‹¤ì œ ë¯¼ì› 5,000ê±´ ìœ„ì¹˜ í´ëŸ¬ìŠ¤í„°ë§ ì‹œê°í™”
- ğŸ“Š ìì¹˜êµ¬ë³„ ê³µì˜ì£¼ì°¨ì¥ ìˆ˜ ë° ë¯¼ì› ê±´ìˆ˜ ë¹„êµ
- ğŸ” ì¸êµ¬ ê¸°ì¤€ ë³´ì •ìœ¼ë¡œ ê³µì •í•œ ë¹„êµ ì œê³µ (ì¸êµ¬ë‹¹ ë¯¼ì›ìˆ˜, ì¸êµ¬ë‹¹ ì£¼ì°¨ì¥ìˆ˜)
- ğŸ“ˆ ìƒê´€ê´€ê³„ ë¶„ì„ ë° íšŒê·€ëª¨í˜•ìœ¼ë¡œ ì •ì±… ë°©í–¥ì„± ë„ì¶œ
  - ê³µì˜ì£¼ì°¨ì¥ì´ ë§ë‹¤ê³  ë¯¼ì›ì´ ë°˜ë“œì‹œ ì¤„ì–´ë“¤ì§€ëŠ” ì•ŠìŒ
  - ì¸êµ¬ë‹¹ ì£¼ì°¨ì¥ìˆ˜ê°€ ë§ì•„ë„ ë¯¼ì›ì€ ì˜¤íˆë ¤ ëŠ˜ì–´ë‚˜ëŠ” ê²½í–¥ì„± ì¡´ì¬
""")

# âœ… í”¼ë“œë°± ë° ê°œì„  ì‚¬í•­
st.markdown("""
## ğŸ§‘â€ğŸ« ë°œí‘œ í”¼ë“œë°± ë° ê°œì„  ë°©í–¥

ì´ë²ˆ ë¶„ì„ í”„ë¡œì íŠ¸ëŠ” ì„œìš¸ì‹œì˜ ê³µì˜ì£¼ì°¨ì¥ê³¼ ë¶ˆë²•ì£¼ì •ì°¨ ë¯¼ì› ë°ì´í„° ê°„ì˜ ê´€ê³„ë¥¼ ì‹œê°í™”í•˜ê³  í†µê³„ì ìœ¼ë¡œ ë¶„ì„í•œ ê²ƒì…ë‹ˆë‹¤. ìˆ˜í–‰ ê³¼ì •ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ë³´ì™„ì ê³¼ ê°œì„  ë°©í–¥ì„ ë„ì¶œí•˜ì˜€ìŠµë‹ˆë‹¤:

---

### 1. ğŸ” ë°ì´í„° ìˆ˜ì§‘ ë° ì „ì²˜ë¦¬
- ë°ì´í„°ì˜ **ì¶œì²˜ì™€ ê¸°ì¤€ ì‹œì **ì— ëŒ€í•œ ì„¤ëª…ì´ ë¶€ì¡±í–ˆìŠµë‹ˆë‹¤.
- ì˜ˆë¥¼ ë“¤ì–´ "2024ë…„ 3ì›”ê¹Œì§€ì˜ ë¯¼ì› ì ‘ìˆ˜ ë°ì´í„°", "ì„œìš¸ì—´ë¦°ë°ì´í„°ê´‘ì¥ ê¸°ì¤€" ë“±ì˜ ì¶œì²˜ ëª…ì‹œëŠ” ë¶„ì„ì˜ **ì‹ ë¢°ë„ë¥¼ ë†’ì´ëŠ” ìš”ì†Œ**ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### 2. ğŸ—ºï¸ ì§€ë„ ì‹œê°í™”
- ë¯¼ì› ìœ„ì¹˜ ë°ì´í„°ëŠ” 5,000ê±´ì„ ë¬´ì‘ìœ„ë¡œ ì‹œê°í™”í–ˆìœ¼ë‚˜, **í•„í„° ê¸°ëŠ¥ì´ ë¶€ì¬**í•´ íŠ¹ì • ìì¹˜êµ¬ë‚˜ ê¸°ê°„ë§Œ ì„ íƒí•´ ë³´ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
- ë°œí‘œ ì´í›„ í™•ì¥ ì•„ì´ë””ì–´ë¡œ, **ìì¹˜êµ¬ë³„ í•„í„°**, **ê¸°ê°„ ìŠ¬ë¼ì´ë”** ë“±ì„ ì¶”ê°€í•´ **ì¸í„°ë™í‹°ë¸Œ ê¸°ëŠ¥ì„ ê°•í™”**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### 3. ğŸ“ˆ ë¶„ì„ ëª¨ë¸ ë° í•´ì„
- íšŒê·€ë¶„ì„ê³¼ ìƒê´€ë¶„ì„ì˜ ê²°ê³¼ëŠ” ìœ ì˜ë¯¸í–ˆìœ¼ë‚˜, **í†µê³„ì  ìœ ì˜ì„±ê³¼ ì¸ê³¼ê´€ê³„ëŠ” ë‹¤ë¥´ë‹¤ëŠ” ì **ì„ ëª…í™•íˆ ì„¤ëª…í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.
- ì˜ˆ: "ê³µì˜ì£¼ì°¨ì¥ì´ ë§ë‹¤ê³  í•´ì„œ ë¯¼ì›ì´ ì¤„ì–´ë“ ë‹¤ëŠ” ë³´ì¥ì€ ì—†ë‹¤."
- ë¶„ì„ì  í•´ì„ë„ ë³´ì™„ í•„ìš”: **ìƒì—…ì§€êµ¬ì¼ìˆ˜ë¡ ì£¼ì°¨ ìˆ˜ìš”ì™€ ë¯¼ì›ì´ í•¨ê»˜ ì¦ê°€í•  ìˆ˜ ìˆìŒ**

---

### 4. ğŸ¨ ì‹œê°í™” êµ¬ì„±
- ê·¸ë˜í”„ ê°„ ìƒ‰ìƒê³¼ ë²”ë¡€ê°€ ì¼ê´€ë˜ì§€ ì•Šì•„ **ì‹œê°ì  í˜¼ë€**ì„ ì¤„ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
- ë¯¼ì› ê±´ìˆ˜ëŠ” í•­ìƒ íŒŒë€ìƒ‰, ì£¼ì°¨ì¥ ìˆ˜ëŠ” ì£¼í™©ìƒ‰ ë“±ìœ¼ë¡œ **ìƒ‰ìƒ ê³ ì •**í•˜ë©´ ë¹„êµê°€ ë” ì§ê´€ì ì…ë‹ˆë‹¤.
- ê° ì§€í‘œë³„ ë‹¨ìœ„ í‘œì‹œ(ì˜ˆ: 1,000ëª…ë‹¹ ê±´ìˆ˜ ë“±)ë„ í•¨ê»˜ ëª…ì‹œí•˜ë©´ ì •í™•í•œ í•´ì„ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.

---

### 5. ğŸ§  ì •ì±…ì  ì‹œì‚¬ì  ì „ë‹¬
- ë¶„ì„ ê²°ê³¼ë¥¼ ë³´ì—¬ì£¼ëŠ” ë° ê·¸ì¹˜ì§€ ì•Šê³ , **í–‰ì •ì Â·ì •ì±…ì  ì˜ë¯¸**ê¹Œì§€ ì—°ê²° ì§“ëŠ” ì„¤ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.
- ì˜ˆ: "ì£¼ì°¨ì¥ì„ ë‹¨ìˆœíˆ ëŠ˜ë¦¬ëŠ” ê²ƒë³´ë‹¤, ì¸êµ¬Â·ìƒê¶ŒÂ·ìœ ë™ì¸êµ¬ ë“±ì„ ê³ ë ¤í•œ ì…ì§€ ì „ëµì´ í•„ìš”í•¨"
- ì´ëŸ¬í•œ **ì¸ì‚¬ì´íŠ¸ ë„ì¶œ**ì´ ë°ì´í„° ë¶„ì„ì˜ í•µì‹¬ ê°€ì¹˜ì…ë‹ˆë‹¤.

---

### âœ… ì¢…í•© ìš”ì•½
- ì‹¤ì œ í–‰ì • ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ì •ì œí•œ í›„, ì‹œê°í™”ì™€ í†µê³„ ë¶„ì„ê¹Œì§€ ì¼ê´€ëœ íë¦„ìœ¼ë¡œ êµ¬ì„±í•œ ì ì—ì„œ ì˜ë¯¸ ìˆëŠ” í”„ë¡œì íŠ¸ì˜€ìŠµë‹ˆë‹¤.
- ë‹¤ë§Œ, ë°œí‘œì—ì„œ êµìˆ˜ë‹˜ê³¼ ë™ë£Œë“¤ì´ **ì •ì±… í•´ì„ê³¼ ì‹¤ìš© ê°€ëŠ¥ì„±ì— ì£¼ëª©**í•  ìˆ˜ ìˆë„ë¡ ë©”ì‹œì§€ë¥¼ ê°•í™”í•˜ëŠ” ê²ƒì´ í–¥í›„ ê°œì„  í¬ì¸íŠ¸ì…ë‹ˆë‹¤.
""")
